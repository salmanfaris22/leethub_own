<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Tournament - 1K+ Students</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-purple-600 to-indigo-800 min-h-screen p-4">
    <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-8 text-center">
            <h1 class="text-4xl font-bold mb-2">üèÜ Coding Tournament</h1>
            <p class="text-lg">Challenge yourself with 7 coding problems</p>
            <button id="logoutBtn" class="hidden mt-2 bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg text-sm font-semibold transition">
                Logout
            </button>
        </div>

        <div class="p-8">
            <!-- Registration Section -->
            <div id="registration" class="section">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Student Registration</h2>
                <form id="regForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Student ID</label>
                        <input type="text" id="studentId" required 
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Full Name</label>
                        <input type="text" id="studentName" required 
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none transition">
                    </div>
                    <button type="submit" 
                        class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg transform hover:-translate-y-1 transition">
                        Start Tournament
                    </button>
                </form>
            </div>

            <!-- Problems List Section -->
            <div id="problemsList" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">Your Problems</h2>
                        <p class="text-gray-600 mt-1">Welcome, <span id="studentNameDisplay" class="font-bold text-purple-600"></span>!</p>
                        <p class="text-gray-600">Total Score: <span id="totalScore" class="font-bold text-purple-600">0</span> points</p>
                    </div>
                    <button id="viewLeaderboard" 
                        class="bg-yellow-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-yellow-600 transition">
                        üèÜ Leaderboard
                    </button>
                </div>
                
                <!-- Progress Bar -->
                <div class="mb-6">
                    <div class="flex justify-between text-sm mb-2">
                        <span class="font-semibold">Progress</span>
                        <span id="progressText" class="font-semibold">0/7</span>
                    </div>
                    <div class="w-full h-8 bg-gray-200 rounded-full overflow-hidden">
                        <div id="progressBar" class="h-full bg-gradient-to-r from-green-400 to-green-600 flex items-center justify-center text-white font-bold transition-all duration-500" style="width: 0%">
                            0%
                        </div>
                    </div>
                </div>

                <!-- Problem Cards -->
                <div class="grid grid-cols-1 gap-4" id="problemCardsContainer"></div>
            </div>

            <!-- Problem Solving Section -->
            <div id="problemSolve" class="section hidden">
                <button id="backToList" class="mb-4 text-purple-600 font-semibold hover:text-purple-800 transition">
                    ‚Üê Back to Problems
                </button>
                
                <div class="flex justify-between items-center mb-4">
                    <h2 id="problemTitle" class="text-3xl font-bold text-gray-800"></h2>
                    <div class="flex gap-2 items-center">
                        <span id="problemDifficulty" class="px-3 py-1 rounded-full text-sm font-semibold"></span>
                        <span id="problemScore" class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-semibold"></span>
                    </div>
                </div>
                <div id="problemDescription" class="bg-gray-50 p-6 rounded-lg mb-6"></div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Select Language</label>
                    <select id="language" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none">
                        <option value="python">Python</option>
                        <option value="javascript">JavaScript</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Your Code</label>
                    <textarea id="codeEditor" 
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none font-mono text-sm h-64"></textarea>
                </div>

                <button id="submitCode" 
                    class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg transform hover:-translate-y-1 transition">
                    Submit & Test
                </button>

                <div id="testResults" class="mt-6"></div>
            </div>

            <!-- Leaderboard Section -->
            <div id="leaderboard" class="section hidden">
                <button id="backFromLeaderboard" class="mb-4 text-purple-600 font-semibold hover:text-purple-800 transition">
                    ‚Üê Back to Problems
                </button>
                
                <h2 class="text-3xl font-bold text-gray-800 mb-6">üèÜ Leaderboard - Top 50</h2>
                <div id="leaderboardContent" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://leethub-own.onrender.com';
        let currentStudent = null;
        let currentProblem = null;
        let problemsData = [];
        let studentProgress = {};
        let totalScore = 0;
        let currentSection = 'registration';

        const problemDescriptions = {
            0: {
                title: "Two Sum",
                description: `Given an array of integers 'nums' and an integer 'target', return indices of two numbers that add up to target.

Example:
Input: nums = [2, 7, 11, 15], target = 9
Output: [0, 1]
Explanation: nums[0] + nums[1] = 2 + 7 = 9

Function Signature:
- Python: def two_sum(nums, target)
- JavaScript: function twoSum(nums, target)`
            },
            1: {
                title: "Array Sum",
                description: `Calculate the sum of all elements in an array.

Example:
Input: nums = [1, 2, 3, 4, 5]
Output: 15

Function Signature:
- Python: def array_sum(nums)
- JavaScript: function arraySum(nums)`
            },
            2: {
                title: "Find Smallest",
                description: `Find and return the smallest number in an array of integers.

Example:
Input: nums = [3, 1, 4, 1, 5, 9, 2, 6]
Output: 1

Function Signature:
- Python: def find_smallest(nums)
- JavaScript: function findSmallest(nums)`
            },
            3: {
                title: "Rotate Image",
                description: `Rotate a 2D matrix by 90 degrees clockwise (in-place).

Example:
Input: [[1,2,3],[4,5,6],[7,8,9]]
Output: [[7,4,1],[8,5,2],[9,6,3]]

Hint: Transpose the matrix, then reverse each row.

Function Signature:
- Python: def rotate_image(matrix)
- JavaScript: function rotateImage(matrix)

Return the rotated matrix.`
            },
            4: {
                title: "Move Zeroes",
                description: `Move all 0's to the end while maintaining the relative order of non-zero elements.

Example:
Input: [0,1,0,3,12]
Output: [1,3,12,0,0]

Hint: Use two pointers - one for non-zero position.

Function Signature:
- Python: def move_zeroes(nums)
- JavaScript: function moveZeroes(nums)

Return the modified array.`
            },
            5: {
                title: "Single Number",
                description: `Given an array where every element appears twice except one, find that single element.

Example:
Input: [4,1,2,1,2]
Output: 4

Hint: Use XOR operation - a^a=0 and a^0=a

Function Signature:
- Python: def single_number(nums)
- JavaScript: function singleNumber(nums)`
            },
            6: {
                title: "Longest Common Prefix",
                description: `Find the longest common prefix string amongst an array of strings.

Example:
Input: ["flower","flow","flight"]
Output: "fl"

Hint: Compare characters at each position across all strings.

Function Signature:
- Python: def longest_common_prefix(strs)
- JavaScript: function longestCommonPrefix(strs)`
            }
        };

        // LocalStorage functions
        function saveToLocalStorage() {
            const data = {
                currentStudent,
                studentProgress,
                totalScore,
                currentSection,
                problemsData,
                timestamp: Date.now()
            };
            localStorage.setItem('codingTournament', JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const data = localStorage.getItem('codingTournament');
            if (data) {
                try {
                    const parsed = JSON.parse(data);
                    
                    // Check if data is not too old (24 hours)
                    const hoursPassed = (Date.now() - parsed.timestamp) / (1000 * 60 * 60);
                    if (hoursPassed > 24) {
                        localStorage.removeItem('codingTournament');
                        return false;
                    }
                    
                    currentStudent = parsed.currentStudent;
                    studentProgress = parsed.studentProgress || {};
                    totalScore = parsed.totalScore || 0;
                    currentSection = parsed.currentSection || 'registration';
                    problemsData = parsed.problemsData || [];
                    
                    return true;
                } catch (e) {
                    console.error('Error loading from localStorage:', e);
                    return false;
                }
            }
            return false;
        }

        function clearLocalStorage() {
            localStorage.removeItem('codingTournament');
            currentStudent = null;
            studentProgress = {};
            totalScore = 0;
            currentSection = 'registration';
            location.reload();
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            const hasData = loadFromLocalStorage();
            
            if (hasData && currentStudent) {
                // User has previous session
                document.getElementById('logoutBtn').classList.remove('hidden');
                await loadProblems();
                
                if (currentSection === 'problemsList' || currentSection === 'problemSolve') {
                    showSection('problemsList');
                    document.getElementById('studentNameDisplay').textContent = currentStudent.name;
                    await loadProgress();
                } else {
                    showSection(currentSection);
                }
            } else {
                showSection('registration');
            }
        });

        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to logout? Your progress is saved on the server.')) {
                clearLocalStorage();
            }
        });

        // Load problems from backend
        async function loadProblems() {
            try {
                const res = await fetch(`${API_URL}/api/problems`);
                const data = await res.json();
                if (res.ok) {
                    problemsData = data.problems;
                    renderProblemCards();
                    saveToLocalStorage();
                }
            } catch (err) {
                console.error('Failed to load problems');
            }
        }

        function renderProblemCards() {
            const container = document.getElementById('problemCardsContainer');
            let html = '';
            
            problemsData.forEach(problem => {
                const difficultyColors = {
                    'Easy': 'bg-green-100 text-green-800',
                    'Medium': 'bg-yellow-100 text-yellow-800',
                    'Hard': 'bg-red-100 text-red-800'
                };
                
                const diffClass = difficultyColors[problem.difficulty] || 'bg-gray-100 text-gray-800';
                
                html += `
                    <div class="problem-card bg-gray-50 p-6 rounded-xl border-2 border-transparent hover:border-purple-500 cursor-pointer transition transform hover:translate-x-2" data-problem="${problem.id}">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-bold text-gray-800">${problem.id + 1}. ${problem.title}</h3>
                            <div class="flex gap-2">
                                <span class="${diffClass} px-3 py-1 rounded-full text-xs font-semibold">${problem.difficulty}</span>
                                <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-xs font-semibold">${problem.max_score} pts</span>
                            </div>
                        </div>
                        <p class="text-gray-600 text-sm">${problemDescriptions[problem.id]?.description.split('\n')[0] || 'Solve this problem'}</p>
                        <div class="mt-3 text-sm">
                            <span class="score-badge-${problem.id} text-gray-500">Not attempted</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Add click listeners
            document.querySelectorAll('.problem-card').forEach(card => {
                card.addEventListener('click', () => {
                    const problemId = parseInt(card.dataset.problem);
                    openProblem(problemId);
                });
            });
        }

        function openProblem(problemId) {
            const problem = problemsData.find(p => p.id === problemId);
            const desc = problemDescriptions[problemId];
            
            if (!problem || !desc) return;
            
            currentProblem = { ...problem, ...desc };
            
            document.getElementById('problemTitle').textContent = `${problemId + 1}. ${problem.title}`;
            document.getElementById('problemDescription').innerHTML = `<pre class="whitespace-pre-wrap text-sm">${desc.description}</pre>`;
            
            const diffColors = {
                'Easy': 'bg-green-100 text-green-800',
                'Medium': 'bg-yellow-100 text-yellow-800',
                'Hard': 'bg-red-100 text-red-800'
            };
            
            document.getElementById('problemDifficulty').textContent = problem.difficulty;
            document.getElementById('problemDifficulty').className = `px-3 py-1 rounded-full text-sm font-semibold ${diffColors[problem.difficulty]}`;
            document.getElementById('problemScore').textContent = `${problem.max_score} points`;
            
            document.getElementById('codeEditor').value = '';
            document.getElementById('testResults').innerHTML = '';
            showSection('problemSolve');
        }

        // Event Listeners
        document.getElementById('regForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentId = document.getElementById('studentId').value.trim();
            const studentName = document.getElementById('studentName').value.trim();

            if (!studentId || !studentName) {
                alert('Please fill all fields');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/api/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ student_id: studentId, name: studentName })
                });
                const data = await res.json();
                if (res.ok) {
                    currentStudent = data.student;
                    document.getElementById('logoutBtn').classList.remove('hidden');
                    document.getElementById('studentNameDisplay').textContent = currentStudent.name;
                    await loadProblems();
                    showSection('problemsList');
                    await loadProgress();
                    saveToLocalStorage();
                } else {
                    alert(data.error || 'Registration failed');
                }
            } catch (err) {
                alert('Error connecting to server. Make sure backend is running on localhost:8080');
            }
        });

        document.getElementById('submitCode').addEventListener('click', async () => {
            const code = document.getElementById('codeEditor').value;
            const language = document.getElementById('language').value;
            
            if (!code.trim()) {
                alert('Please write some code first');
                return;
            }

            const btn = document.getElementById('submitCode');
            btn.disabled = true;
            btn.textContent = '‚è≥ Testing...';

            try {
                const res = await fetch(`${API_URL}/api/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        student_id: currentStudent.student_id,
                        problem_id: currentProblem.id,
                        code: code,
                        language: language
                    })
                });
                const data = await res.json();
                
                if (res.ok) {
                    displayResults(data);
                    await loadProgress();
                    saveToLocalStorage();
                } else {
                    alert(data.error || 'Submission failed');
                }
            } catch (err) {
                alert('Error connecting to server');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Submit & Test';
            }
        });

        document.getElementById('backToList').addEventListener('click', () => {
            showSection('problemsList');
        });

        document.getElementById('viewLeaderboard').addEventListener('click', async () => {
            await loadLeaderboard();
            showSection('leaderboard');
        });

        document.getElementById('backFromLeaderboard').addEventListener('click', () => {
            showSection('problemsList');
        });

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            currentSection = sectionId;
            saveToLocalStorage();
        }

        function displayResults(data) {
            const resultsDiv = document.getElementById('testResults');
            let html = `<div class="space-y-3">`;
            
            html += `<div class="bg-purple-50 border-2 border-purple-500 p-4 rounded-lg mb-4">
                <div class="flex justify-between items-center">
                    <div class="text-lg font-bold">Score: ${data.earned_score}/${data.max_score} points</div>
                    <div class="text-sm font-semibold">${data.passed_count}/${data.total_tests} tests passed</div>
                </div>
            </div>`;
            
            data.results.forEach((result, idx) => {
                const bgColor = result.passed ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500';
                const icon = result.passed ? '‚úÖ' : '‚ùå';
                html += `
                    <div class="${bgColor} border-2 p-4 rounded-lg">
                        <div class="font-bold mb-2">${icon} Test Case ${idx + 1}</div>
                        <div class="font-mono text-sm space-y-1">
                            <div><span class="font-semibold">Expected:</span> ${JSON.stringify(result.expected)}</div>
                            <div><span class="font-semibold">Got:</span> ${JSON.stringify(result.output)}</div>
                            ${result.error ? `<div class="text-red-600 mt-2 font-semibold">‚ö†Ô∏è ${result.error}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            if (data.all_passed) {
                html += `<div class="bg-green-100 border-2 border-green-500 p-4 rounded-lg text-center">
                    <div class="text-2xl">üéâ Congratulations!</div>
                    <div class="text-lg font-bold text-green-700">All tests passed! You earned ${data.earned_score} points!</div>
                </div>`;
            }
            
            html += `</div>`;
            resultsDiv.innerHTML = html;
        }

        async function loadProgress() {
            try {
                const res = await fetch(`${API_URL}/api/progress/${currentStudent.student_id}`);
                const data = await res.json();
                if (res.ok) {
                    studentProgress = {};
                    totalScore = data.total_score || 0;
                    
                    if (data.progress) {
                        data.progress.forEach(p => {
                            studentProgress[p.problem_id] = p.score;
                        });
                    }
                    
                    updateProgress();
                    saveToLocalStorage();
                }
            } catch (err) {
                console.error('Failed to load progress');
            }
        }

        function updateProgress() {
            const completed = Object.keys(studentProgress).length;
            const total = problemsData.length;
            const percentage = total > 0 ? (completed / total * 100).toFixed(0) : 0;
            
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressBar').textContent = percentage + '%';
            document.getElementById('progressText').textContent = `${completed}/${total}`;
            document.getElementById('totalScore').textContent = totalScore;

            // Update problem cards with scores
            problemsData.forEach(problem => {
                const card = document.querySelector(`.problem-card[data-problem="${problem.id}"]`);
                const badge = document.querySelector(`.score-badge-${problem.id}`);
                
                if (studentProgress[problem.id] !== undefined) {
                    const score = studentProgress[problem.id];
                    const maxScore = problem.max_score;
                    
                    if (badge) {
                        if (score === maxScore) {
                            badge.textContent = `‚úÖ ${score}/${maxScore} pts`;
                            badge.className = 'text-green-600 font-semibold';
                            card?.classList.add('bg-green-50', 'border-green-500');
                        } else {
                            badge.textContent = `‚ö†Ô∏è ${score}/${maxScore} pts`;
                            badge.className = 'text-yellow-600 font-semibold';
                            card?.classList.add('bg-yellow-50', 'border-yellow-500');
                        }
                    }
                }
            });
        }

        async function loadLeaderboard() {
            try {
                const res = await fetch(`${API_URL}/api/leaderboard`);
                const data = await res.json();
                if (res.ok) {
                    displayLeaderboard(data.leaderboard);
                }
            } catch (err) {
                alert('Failed to load leaderboard');
            }
        }

        function displayLeaderboard(entries) {
            const content = document.getElementById('leaderboardContent');
            let html = '';
            
            if (!entries || entries.length === 0) {
                html = '<div class="text-center text-gray-500 py-8">No submissions yet. Be the first!</div>';
            } else {
                entries.forEach((entry, idx) => {
                    const medals = ['ü•á', 'ü•à', 'ü•â'];
                    const medal = idx < 3 ? medals[idx] : '';
                    const isCurrentUser = currentStudent && entry.student_id === currentStudent.student_id;
                    const highlight = isCurrentUser ? 'ring-2 ring-purple-500 bg-purple-50' : 'bg-gray-50';
                    
                    html += `
                        <div class="flex justify-between items-center ${highlight} p-4 rounded-lg border-l-4 border-purple-500">
                            <div class="flex items-center gap-4">
                                <span class="text-2xl font-bold text-gray-400 w-8">#${idx + 1}</span>
                                ${medal ? `<span class="text-3xl">${medal}</span>` : '<span class="w-8"></span>'}
                                <div>
                                    <div class="font-semibold text-lg">${entry.name} ${isCurrentUser ? '(You)' : ''}</div>
                                    <div class="text-sm text-gray-500">${entry.student_id}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold text-purple-600">${entry.score}</div>
                                <div class="text-sm text-gray-500">points</div>
                            </div>
                        </div>
                    `;
                });
            }
            
            content.innerHTML = html;
        }

        // Auto-save on beforeunload
        window.addEventListener('beforeunload', () => {
            saveToLocalStorage();
        });
    </script>
</body>
</html>